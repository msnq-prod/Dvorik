{% extends 'base.html' %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="mb-0">{{ table_title(table) }}</h3>
      {% if is_readonly %}
        <span class="badge bg-secondary">Только чтение</span>
      {% endif %}
    </div>
    <div>
      {% if not is_readonly %}
      <a class="btn btn-success" href="{{ url_for('table_add', table=table) }}">Добавить</a>
      {% endif %}
    </div>
  </div>

  <form method="get" class="row g-2 align-items-center mb-3">
    <div class="col-auto">
      <input type="text" name="q" value="{{ q or '' }}" placeholder="Поиск по текстовым полям" class="form-control" />
    </div>
    <div class="col-auto">
      <select class="form-select" name="per_page" onchange="this.form.submit()">
        {% for n in [25,50,100,200,500] %}
          <option value="{{n}}" {% if per_page==n %}selected{% endif %}>{{ n }} / стр</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">Искать</button>
    </div>
  </form>

  <div class="table-wrap">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          {% for c in cols %}
            <th>
              <a href="{{ url_for('table_browse', table=table, q=q, per_page=per_page, sort=c.name, dir='desc' if (sort==c.name and dir=='asc') else 'asc') }}">
                {{ col_title(table, c.name) }}
                {% if c.pk_order %}
                  <span class="badge bg-info pk-badge ms-1">Ключ</span>
                {% endif %}
              </a>
            </th>
          {% endfor %}
          <th class="text-end" style="width:1%">Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            {% for c in cols %}
              <td class="small">{{ value_label(table, c.name, r[c.name]) }}</td>
            {% endfor %}
            <td>
              <div class="d-flex gap-2 justify-content-end">
                {% if not is_readonly %}
                <a class="btn btn-sm btn-outline-primary" href="{{ edit_url(table, r, pkcols) }}">Изменить</a>
                <form method="post" action="{{ url_for('table_delete', table=table) }}" onsubmit="return confirm('Удалить строку?')">
                  {% for pk in pkcols %}
                    <input type="hidden" name="{{ pk.name }}" value="{{ r[pk.name] }}" />
                  {% endfor %}
                  <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
                </form>
                {% if table == 'product' %}
                <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#transferModalProducts" data-pid="{{ r['id'] }}" data-name="{{ r['local_name'] or r['name'] or ('#' ~ r['id']) }}">Переместить</button>
                {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if table == 'product' %}
  <!-- Modal: Transfer from products list -->
  <div class="modal fade" id="transferModalProducts" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" method="post" action="{{ url_for('stock_move') }}">
        <div class="modal-header">
          <h5 class="modal-title">Переместить: <span id="trpName"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="product_id" id="trpPid">
          <div class="mb-2">
            <label class="form-label">Откуда</label>
            <select class="form-select" name="src" id="trpSrc">
              {% for l in locations %}
                <option value="{{ l['code'] }}">{{ l['title'] }} ({{ l['code'] }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Куда</label>
            <select class="form-select" name="dst" id="trpDst">
              {% for l in locations %}
                <option value="{{ l['code'] }}">{{ l['title'] }} ({{ l['code'] }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Количество</label>
            <input type="number" class="form-control" name="qty" value="1" min="1">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Переместить</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function(){
      const m = document.getElementById('transferModalProducts');
      if(!m) return;
      m.addEventListener('show.bs.modal', function(ev){
        const b = ev.relatedTarget;
        document.getElementById('trpPid').value = b.getAttribute('data-pid');
        document.getElementById('trpName').textContent = b.getAttribute('data-name');
      });
    })();
  </script>
  {% endif %}

  <nav aria-label="pages">
    <ul class="pagination">
      <li class="page-item {% if page<=1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('table_browse', table=table, q=q, per_page=per_page, page=page-1 if page>1 else 1, sort=sort, dir=dir) }}">Назад</a>
      </li>
      <li class="page-item disabled"><span class="page-link">Стр. {{ page }} / {{ pages }} ({{ total }})</span></li>
      <li class="page-item {% if page>=pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('table_browse', table=table, q=q, per_page=per_page, page=page+1 if page<pages else pages, sort=sort, dir=dir) }}">Вперёд</a>
      </li>
    </ul>
  </nav>
{% endblock %}
