# MARM Bot ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π README (v2)

–¢–µ–ª–µ–≥—Ä–∞–º‚Äë–±–æ—Ç —Å–∫–ª–∞–¥—Å–∫–æ–≥–æ —É—á—ë—Ç–∞ –Ω–∞ Python 3.12 + aiogram 3.7 + SQLite (WAL, FTS5 –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏). –≠—Ç–∞ –≤–µ—Ä—Å–∏—è README —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –±—ã—Å—Ç—Ä–æ–º –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö. –î–ª—è –±–æ–ª–µ–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è —Å–º. –æ—Å–Ω–æ–≤–Ω–æ–π `README.md`.


## TL;DR (—Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ)

1) –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `config.json` —Å —Ç–æ–∫–µ–Ω–æ–º –∏ –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–æ–º.
2) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—á–µ—Ä–µ–∑ `./run_bot.command` –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –≤ venv).
3) –ó–∞–ø—É—Å—Ç–∏—Ç–µ `python -m app.main`.
4) –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É `/start` —Å –∞–∫–∫–∞—É–Ω—Ç–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ ¬´–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞¬ª –∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω—É–∂–Ω—ã–µ —Ä–æ–ª–∏.
5) –î–ª—è –ø–æ—Å—Ç–∞–≤–æ–∫: ¬´–ü–æ—Å—Ç–∞–≤–∫–∞ ‚Üí –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel/CSV ‚Üí –ò–º–ø–æ—Ä—Ç ‚Üí –†–∞–∑–ª–æ–∂–∏—Ç—å –ø–æ –ª–æ–∫–∞—Ü–∏—è–º¬ª.


## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

- macOS (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
```
./run_bot.command
```
- –í—Ä—É—á–Ω—É—é (macOS/Linux/Windows):
```
python3.12 -m venv venv
source venv/bin/activate        # Windows: venv\Scripts\activate
pip install -U pip
pip install -r requirements.txt
python -m app.main
```

–ï—Å–ª–∏ Python 3.12 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (macOS): `brew install python@3.12`.


## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–§–∞–π–ª `config.json` (—Ä—è–¥–æ–º —Å `app/main.py`):
```json
{
  "BOT_TOKEN": "<–í–ê–®_–¢–û–ö–ï–ù>",
  "SUPER_ADMIN_ID": 123456789,
  "SUPER_ADMIN_USERNAME": "@your_username"
}
```
–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: `BOT_TOKEN`, `SUPER_ADMIN_ID`, `SUPER_ADMIN_USERNAME`.

–î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ë–î: `data/marm.sqlite3`
- –ó–∞–≥—Ä—É–∑–∫–∏: `data/uploads` ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ CSV: `data/uploads/normalized`
- –§–æ—Ç–æ: `media/photos`
- –û—Ç—á—ë—Ç—ã: `reports`

–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã: `app/config.py` (–∫–∞—á–µ—Å—Ç–≤–æ JPEG, –ø–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Ç.–¥.).


## –†–æ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø

- –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω (–∏–∑ `config.json`): –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∞–¥–º–∏–Ω–∞–º–∏.
- –ê–¥–º–∏–Ω: –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø (–ø–æ—Å—Ç–∞–≤–∫–∞, –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è, –æ—Ç—á—ë—Ç—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è).
- –ü—Ä–æ–¥–∞–≤–µ—Ü: –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –Ω–∞–ª–∏—á–∏—è –∏ –±–∞–∑–æ–≤—ã–º –æ–ø–µ—Ä–∞—Ü–∏—è–º.

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π ‚Äî —á–µ—Ä–µ–∑ ¬´–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞¬ª.


## –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1) –ò–º–ø–æ—Ä—Ç –ø–æ—Å—Ç–∞–≤–∫–∏
- –û—Ç–∫—Ä–æ–π—Ç–µ ¬´–ü–æ—Å—Ç–∞–≤–∫–∞ ‚Üí üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á—ë—Ç (CSV/XLS)¬ª. –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π Excel –∏–ª–∏ CSV.
- –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç SHA-256, –Ω–µ –¥–∞—ë—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Å—á—ë—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `article,name,qty` –≤ `data/uploads/normalized`, –ø—Ä–∏—Å—ã–ª–∞–µ—Ç CSV –∏ –ø–∏—à–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ –∂—É—Ä–Ω–∞–ª `import_log`.
- –ù–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –ø–æ–º–µ—á–∞—é—Ç—Å—è `is_new=1`, –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞—á–∏—Å–ª—è–µ—Ç—Å—è –≤ `SKL-0`.
- –†–∞–∑–ª–æ–∂–∏—Ç–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º –∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–ª–∏ —á–µ—Ä–µ–∑ ¬´–ú–∞—Ä—à—Ä—É—Ç: –æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞¬ª.

2) –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞
- –í–∏–¥–Ω–æ –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º –∏ –∏—Ç–æ–≥, –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏–º—è, —Ñ–æ—Ç–æ.
- –ë—ã—Å—Ç—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ¬´–í –∑–∞–ª (‚àí1)¬ª.
- –ú–∞—Ä—à—Ä—É—Ç: –≤—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫/–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.
- –°–ø–µ—Ü‚Äë–∫–Ω–æ–ø–∫–∞ ¬´–í—Å—ë –∏–∑ SKL‚Äë0 ‚Üí –•¬ª: –ø–æ—è–≤–ª—è–µ—Ç—Å—è, –µ—Å–ª–∏ –µ—Å—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è.
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏: ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ¬ª, ¬´–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ¬ª (—Å–∂–∞—Ç–∏–µ JPEG √ó0.5, –∫–µ—à –ª–æ–∫–∞–ª—å–Ω–æ).

3) –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
- ¬´–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è¬ª ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é ‚Üí –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–æ–∑–∏—Ü–∏—é.
- –ö–Ω–æ–ø–∫–∞–º–∏ –∑–∞–¥–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (‚àí5/‚àí1/+1/+5, ¬´‚úÖ —á–∏—Å–ª–æ¬ª) –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ ¬´‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ X¬ª –∏–ª–∏ ¬´‚ûñ –£–±–∞–≤–∏—Ç—å –∏–∑ X¬ª.
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏, —É—Ö–æ–¥ –≤ –º–∏–Ω—É—Å –Ω–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.

4) –û—Ç—á—ë—Ç—ã (CSV)
- ¬´–û—Ç—á—ë—Ç—ã¬ª: ¬´–ó–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è (<2)¬ª, ¬´–ù—É–ª–µ–≤–æ–π –æ—Å—Ç–∞—Ç–æ–∫¬ª, ¬´–í –¥–æ—Å—Ç–∞—Ç–∫–µ 3‚Äì5¬ª, ¬´–í—Å–µ —Ç–æ–≤–∞—Ä—ã¬ª, ¬´–ê—Ä—Ö–∏–≤¬ª.
- –§–∞–π–ª—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ `reports/` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —á–∞—Ç. –ê—Ä—Ö–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Å–∫—Ä—ã—Ç—ã –∏–∑ –æ–±—â–µ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –≤–∏–¥–Ω—ã –≤ ¬´–ê—Ä—Ö–∏–≤–µ¬ª. –ê–≤—Ç–æ–∞—Ä—Ö–∏–≤–∞—Ü–∏—è: –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –æ—Å—Ç–∞—Ç–∫–µ –±–µ–∑ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π 30 –¥–Ω–µ–π.

5) –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –¢–∏–ø—ã: –∑–∞–∫–æ–Ω—á–∏–ª—Å—è, –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–∞—á–∫–∞, –ø–æ—Å—Ç—É–ø–∏–ª–æ –Ω–∞ —Å–∫–ª–∞–¥.
- –†–µ–∂–∏–º—ã: `off` / `daily` / `instant`.
- –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ 21:10 –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞: ¬´–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª –≤ –∞–¥–º–∏–Ω–∫–µ.


## –ü–æ–∏—Å–∫ ‚Äî —à–ø–∞—Ä–≥–∞–ª–∫–∞ (inline)

- –û–±—ã—á–Ω—ã–π: –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ/–∞—Ä—Ç–∏–∫—É–ª ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É.
- –ü—Ä–µ—Ñ–∏–∫—Å—ã —Ä–µ–∂–∏–º–∞:
  - `INV ` ‚Äî –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è, –≤—Å—Ç–∞–≤–ª—è–µ—Ç `/inv_<id>`
  - `NEW ` ‚Äî —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ (`is_new=1`)
  - `INC ` ‚Äî –Ω–µ–∑–∞–ø–æ–ª–Ω—ë–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏/—Ñ–æ—Ç–æ)
  - `ADM ` ‚Äî –∞–¥–º–∏–Ω‚Äë–¥–µ–π—Å—Ç–≤–∏—è, –≤—Å—Ç–∞–≤–ª—è–µ—Ç `/admin_<id>`

–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º ‚Äî FTS5 (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ) —Å fallback –Ω–∞ `LIKE`.


## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ë–î

- SQLite –≤ WAL, `busy_timeout`, `synchronous=NORMAL` ‚Äî —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏.
- –°—Ö–µ–º–∞: `product`, `location`, `stock`, `user_role`, `user_notify`, `event_log`, –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è `product_fts`.
- –ú–∏–≥—Ä–∞—Ü–∏–∏/—Å–∏–¥–∏–Ω–≥ –ª–æ–∫–∞—Ü–∏–π –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (`app/db.py`).


## –°—Ç—Ä–µ—Å—Å‚Äë–ø—Ä–æ–≤–µ—Ä–∫–∞ (–±–µ–∑ Telegram)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ:
```
python stress_test.py
```
–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—É—é –ë–î `data/stress.sqlite3`, –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ CSV –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–∞—Å—Å–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è/–∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã/FTS, –∏–º–∏—Ç–∏—Ä—É–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–∂–∞—Ç–∏–µ —Ñ–æ—Ç–æ. –ò—â–∏—Ç–µ `OVERALL: OK` –≤ –∫–æ–Ω—Ü–µ.


## –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–∫—Ä–∞—Ç–∫–æ)

- –ù–µ—Ç `BOT_TOKEN`/`SUPER_ADMIN_ID` ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `config.json` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
- –ù–µ—Ç Python 3.12 ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ (–Ω–∞ macOS: `brew install python@3.12`).
- –û—à–∏–±–∫–∏ `.xls` ‚Äî –Ω—É–∂–µ–Ω `xlrd==1.2.0` (—É–∂–µ –≤ `requirements.txt`).
- FTS –ø–∞–¥–∞–µ—Ç ‚Äî –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞: –±—É–¥–µ—Ç `LIKE`.
- ¬´database is locked¬ª –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ ‚Äî –ø–æ–¥–æ–∂–¥–∏—Ç–µ/–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ; WAL –∏ `busy_timeout` —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã.
- –§–æ—Ç–æ –Ω–µ –≤–∏–¥–Ω–æ ‚Äî –¥–æ–∂–¥–∏—Ç–µ—Å—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â—ë —Ä–∞–∑.


## –§–∞–π–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (–∫—É–¥–∞ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∫–æ–¥–µ)

- –í—Ö–æ–¥: `app/main.py`
- –ö–æ–Ω—Ñ–∏–≥/–ø—É—Ç–∏: `app/config.py`
- –ë–î/—Å—Ö–µ–º–∞/–ø—Ä–∞–≥–º—ã: `app/db.py`
- –ò–º–ø–æ—Ä—Ç: `app/services/imports.py`
- –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏—è/–∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è: `app/services/stock.py`
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: `app/services/notify.py`
- –§–æ—Ç–æ: `app/services/photos.py`
- UI/—Ç–µ–∫—Å—Ç—ã/–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: `app/ui/*`
- –•–µ–Ω–¥–ª–µ—Ä—ã: `app/handlers/*`

---
–≠—Ç–∞ ¬´v2¬ª –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏. –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –≥–∞–π–¥, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π `README.md`.
