{% extends 'base.html' %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('schedule_view', year=ms.year if ms.month>1 else ms.year-1, month=(ms.month-1) if ms.month>1 else 12) }}">←</a>
      <h3 class="mb-0">{{ month_ru(ms) }}</h3>
      <a class="btn btn-outline-secondary" href="{{ url_for('schedule_view', year=me.year if me.month<12 else me.year+1, month=(me.month+1) if me.month<12 else 1) }}">→</a>
    </div>
    <form method="post" action="{{ url_for('schedule_clear_month') }}" class="d-inline">
      <input type="hidden" name="year" value="{{ ms.year }}">
      <input type="hidden" name="month" value="{{ ms.month }}">
      <button class="btn btn-outline-warning" type="submit" onclick="return confirm('Очистить назначения за месяц?')">Обнулить график</button>
    </form>
  </div>

  

  <div class="table-responsive" id="schedWrap">
  <table class="sched-table mb-3" id="schedTable" aria-label="График выхода сотрудников">
    <thead>
      <tr>
        <th class="seller-col" scope="col"></th>
        <th scope="col">пн</th>
        <th scope="col">вт</th>
        <th scope="col">ср</th>
        <th scope="col">чт</th>
        <th scope="col">пт</th>
        <th scope="col">сб</th>
        <th scope="col">вс</th>
      </tr>
    </thead>
    <tbody>
      {% for week in weeks %}
        <tr>
          <td class="seller-col"></td>
          {% for d in week %}
            <td class="day-num">{{ d.date.day if d else '' }}</td>
          {% endfor %}
        </tr>
        {% for s in sellers %}
          <tr>
            <td class="seller-col">{{ s.display_name or s.username or ('Продавец ' ~ loop.index) }}</td>
            {% for d in week %}
              {% if not d %}
                <td></td>
              {% else %}
                <td class="{% if s.tg_id in d.assignments %}on{% endif %}">
                  <form method="post" action="{{ url_for('schedule_toggle_cell') }}">
                    <input type="hidden" name="date" value="{{ d.date.isoformat() }}">
                    <input type="hidden" name="tg_id" value="{{ s.tg_id }}">
                    <button class="cell-btn" type="submit" title="{{ (s.display_name or s.username or s.tg_id) ~ ' — ' ~ d.date.isoformat() }}">{% if s.tg_id in d.assignments %}✓{% else %}&nbsp;{% endif %}</button>
                  </form>
                </td>
              {% endif %}
            {% endfor %}
          </tr>
        {% endfor %}
      {% endfor %}
    </tbody>
  </table>
  </div>

  

  <div class="reports">
    <div class="reports-grid mb-2">
      <a class="btn btn-outline-info w-100" href="{{ url_for('schedule_view', year=ms.year, month=ms.month, report='low') }}">Заканчиваются (&lt;2)</a>
      <a class="btn btn-outline-info w-100" href="{{ url_for('schedule_view', year=ms.year, month=ms.month, report='zero') }}">Нулевой остаток</a>
      <a class="btn btn-outline-info w-100" href="{{ url_for('schedule_view', year=ms.year, month=ms.month, report='mid') }}">В достатке 3–5</a>
      <a class="btn btn-outline-info w-100" href="{{ url_for('schedule_view', year=ms.year, month=ms.month, report='all') }}">Все товары</a>
      <a class="btn btn-outline-info w-100" href="{{ url_for('schedule_view', year=ms.year, month=ms.month, report='arch') }}">Архив</a>
    </div>
    {% if report_rows is not none %}
      <div class="card neon-card">
        <div class="card-body">
          <h5 class="card-title mb-3">Отчёт: 
            {% if report_kind=='low' %}Заканчиваются (&lt;2){% elif report_kind=='zero' %}Нулевой остаток{% elif report_kind=='mid' %}В достатке 3–5{% elif report_kind=='all' %}Все товары{% elif report_kind=='arch' %}Архив{% endif %}
          </h5>
          <div class="table-responsive">
            <table class="table neon-table table-sm">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Артикул</th>
                  {% if report_kind!='zero' %}<th>Итого</th>{% endif %}
                  {% if report_kind=='arch' %}<th>Архивирован</th><th>Последнее поступление</th>{% endif %}
                </tr>
              </thead>
              <tbody>
                {% for r in report_rows %}
                  <tr>
                    <td>{{ r.name }}</td>
                    <td>{{ r.article }}</td>
                    {% if report_kind!='zero' and report_kind!='arch' %}<td>{{ '%g' % (r.total) }}</td>{% endif %}
                    {% if report_kind=='arch' %}<td>{{ r.archived_at or '' }}</td><td>{{ r.last_restock_at or '' }}</td>{% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
  <script>
    // Persist horizontal scroll and fit seller column to longest name
    (function(){
      const wrap = document.getElementById('schedWrap');
      if(!wrap) return;
      const KEY = 'scrollX:'+location.pathname+location.search;
      const restore = ()=>{
        try {
          const v = sessionStorage.getItem(KEY);
          if(v!==null){ wrap.scrollLeft = parseInt(v,10)||0; }
        } catch(e){}
      };
      document.addEventListener('DOMContentLoaded', restore);
      restore();
      window.addEventListener('beforeunload', function(){
        try { sessionStorage.setItem(KEY, String(wrap.scrollLeft||0)); } catch(e){}
      });
      // Compute seller column width based on longest name
      const cells = document.querySelectorAll('#schedTable td.seller-col, #schedTable th.seller-col');
      let w = 0;
      cells.forEach(c=>{ w=Math.max(w, c.scrollWidth); });
      if(w>0){ document.getElementById('schedTable').style.setProperty('--seller-w', (w+24)+'px'); }
    })();
  </script>
{% endblock %}
