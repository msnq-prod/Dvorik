{% extends 'base.html' %}
{% from '_macros.html' import page_header, card, table_container %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div>
      <h3 class="mb-0">{{ table_title(table) }}</h3>
      {% if is_readonly %}
        <span class="badge bg-secondary">Только чтение</span>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      {% if not is_readonly %}
      <a class="btn btn-outline-info" href="{{ url_for('table_add', table=table) }}">Добавить</a>
      {% endif %}
    </div>
  </div>

  <form method="get" class="row g-2 align-items-center mb-3">
    <div class="col-auto">
      <input type="text" name="q" value="{{ q or '' }}" placeholder="Поиск по текстовым полям" class="form-control" />
    </div>
    {% if table != 'product' %}
    <div class="col-auto">
      <select class="form-select" name="per_page" onchange="this.form.submit()">
        {% for n in [25,50,100,200,500] %}
          <option value="{{n}}" {% if per_page==n %}selected{% endif %}>{{ n }} / стр</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">Искать</button>
    </div>
  </form>

  <div class="card neon-card">
    {% set cols_to_render = display_cols | default(cols, true) %}
    <div class="table-wrap table-responsive">
    <table class="table neon-table align-middle mb-0">
      <thead>
        <tr>
          {% for c in cols_to_render %}
            <th>
              <a href="{{ url_for('table_browse', table=table, q=q, per_page=per_page, sort=c.name, dir='desc' if (sort==c.name and dir=='asc') else 'asc') }}">
                {{ col_title(table, c.name) }}
                {% if c.pk_order %}
                  <span class="badge" style="background: color-mix(in srgb, var(--brand-2) 22%, transparent);">Ключ</span>
                {% endif %}
              </a>
            </th>
          {% endfor %}
          <th class="text-end" style="width:1%">Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          {% set row_identifier = r[pkcols[0].name] if pkcols else loop.index0 %}
          {% set row_form_id = 'product-inline-form-' ~ row_identifier %}
          <tr{% if table == 'product' %} data-product-row="true"{% if pkcols %} data-product-key="{{ r[pkcols[0].name]|e }}"{% endif %}{% endif %}>
            {% for c in cols_to_render %}
              {% if table == 'product' and c.name in ('name', 'local_name') %}
                {% set raw_value = r[c.name] %}
                {% set display_value = value_label(table, c.name, r[c.name]) %}
                <td class="small product-inline-cell" data-field="{{ c.name }}" data-initial="{{ (raw_value or '')|e }}" data-display-initial="{{ display_value|e }}">
                  <span class="product-inline-view">{{ display_value }}</span>
                  <input form="{{ row_form_id }}" type="text" class="form-control form-control-sm product-inline-input d-none" name="{{ c.name }}" value="{{ (raw_value or '')|e }}" disabled />
                </td>
              {% else %}
                <td class="small">{{ value_label(table, c.name, r[c.name]) }}</td>
              {% endif %}
            {% endfor %}
            <td>
              <div class="d-flex gap-2 justify-content-end flex-wrap">
                {% if not is_readonly %}
                  {% if table == 'product' %}
                  <form id="{{ row_form_id }}" method="post" action="{{ edit_url(table, r, pkcols) }}" class="d-flex gap-2 product-inline-form">
                    <button type="button" class="btn btn-sm btn-outline-info product-edit-btn">Изменить</button>
                    <button type="submit" class="btn btn-sm btn-primary product-save-btn d-none">Сохранить</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary product-cancel-btn d-none">Отмена</button>
                  </form>
                  {% else %}
                  <a class="btn btn-sm btn-outline-info" href="{{ edit_url(table, r, pkcols) }}">Изменить</a>
                  {% endif %}
                  <form method="post" action="{{ url_for('table_delete', table=table) }}" onsubmit="return confirm('Удалить строку?')">
                    {% for pk in pkcols %}
                      <input type="hidden" name="{{ pk.name }}" value="{{ r[pk.name] }}" />
                    {% endfor %}
                    <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
                  </form>
                  {% if table == 'product' %}
                  <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#transferModalProducts" data-pid="{{ r['id'] }}" data-name="{{ r['local_name'] or r['name'] or ('#' ~ r['id']) }}">Переместить</button>
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>

  {% if table == 'product' %}
  <!-- Modal: Transfer from products list -->
  <div class="modal fade" id="transferModalProducts" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" method="post" action="{{ url_for('stock_move') }}">
        <div class="modal-header">
          <h5 class="modal-title">Переместить: <span id="trpName"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="product_id" id="trpPid">
          <div class="mb-2">
            <label class="form-label">Откуда</label>
            <select class="form-select" name="src" id="trpSrc">
              {% for l in locations %}
                <option value="{{ l['code'] }}">{{ l['title'] }} ({{ l['code'] }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Куда</label>
            <select class="form-select" name="dst" id="trpDst">
              {% for l in locations %}
                <option value="{{ l['code'] }}">{{ l['title'] }} ({{ l['code'] }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Количество</label>
            <input type="number" class="form-control" name="qty" value="1" min="1">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Переместить</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function(){
      const m = document.getElementById('transferModalProducts');
      if(!m) return;
      m.addEventListener('show.bs.modal', function(ev){
        const b = ev.relatedTarget;
        document.getElementById('trpPid').value = b.getAttribute('data-pid');
        document.getElementById('trpName').textContent = b.getAttribute('data-name');
      });
    })();
  </script>
  <script>
    (function(){
      const rows = document.querySelectorAll('tr[data-product-row="true"]');
      rows.forEach(function(row){
        const form = row.querySelector('.product-inline-form');
        if(!form) return;
        const editBtn = form.querySelector('.product-edit-btn');
        const saveBtn = form.querySelector('.product-save-btn');
        const cancelBtn = form.querySelector('.product-cancel-btn');
        const cells = row.querySelectorAll('.product-inline-cell');
        if(!editBtn || !saveBtn || !cancelBtn || cells.length === 0) return;

        function setMode(editing){
          cells.forEach(function(cell){
            const input = cell.querySelector('.product-inline-input');
            const view = cell.querySelector('.product-inline-view');
            if(!input || !view) return;
            if(editing){
              view.classList.add('d-none');
              input.classList.remove('d-none');
              input.disabled = false;
            } else {
              view.classList.remove('d-none');
              input.classList.add('d-none');
              input.disabled = true;
            }
          });
          if(editing){
            editBtn.classList.add('d-none');
            saveBtn.classList.remove('d-none');
            cancelBtn.classList.remove('d-none');
            const firstInput = row.querySelector('.product-inline-input');
            if(firstInput){
              firstInput.focus();
              firstInput.select();
            }
          } else {
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            cancelBtn.classList.add('d-none');
          }
        }

        function resetValues(){
          cells.forEach(function(cell){
            const input = cell.querySelector('.product-inline-input');
            const view = cell.querySelector('.product-inline-view');
            if(!input || !view) return;
            const initial = cell.getAttribute('data-initial') || '';
            const displayInitial = cell.getAttribute('data-display-initial') || initial;
            input.value = initial;
            view.textContent = displayInitial;
          });
        }

        editBtn.addEventListener('click', function(){
          setMode(true);
        });
        cancelBtn.addEventListener('click', function(){
          resetValues();
          setMode(false);
        });
        form.addEventListener('submit', function(){
          cells.forEach(function(cell){
            const input = cell.querySelector('.product-inline-input');
            if(input){
              input.disabled = false;
            }
          });
        });
      });
    })();
  </script>
  {% endif %}

  {% if table != 'product' %}
  <nav aria-label="pages" class="mt-3">
    <ul class="pagination">
      <li class="page-item {% if page<=1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('table_browse', table=table, q=q, per_page=per_page, page=page-1 if page>1 else 1, sort=sort, dir=dir) }}">Назад</a>
      </li>
      <li class="page-item disabled"><span class="page-link">Стр. {{ page }} / {{ pages }} ({{ total }})</span></li>
      <li class="page-item {% if page>=pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('table_browse', table=table, q=q, per_page=per_page, page=page+1 if page<pages else pages, sort=sort, dir=dir) }}">Вперёд</a>
      </li>
    </ul>
  </nav>
  {% endif %}
{% endblock %}
